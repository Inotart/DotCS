title1 = \
"""
  ____        _    ____ ____     ____                                      _ _         
 |  _ \  ___ | |_ / ___/ ___|   / ___|___  _ __ ___  _ __ ___  _   _ _ __ (_) |_ _   _ 
 | | | |/ _ \| __| |   \___ \  | |   / _ \| '_ ` _ \| '_ ` _ \| | | | '_ \| | __| | | |
 | |_| | (_) | |_| |___ ___) | | |__| (_) | | | | | | | | | | | |_| | | | | | |_| |_| |
 |____/ \___/ \__|\____|____/   \____\___/|_| |_| |_|_| |_| |_|\__,_|_| |_|_|\__|\__, |
                                                                                 |___/ 
"""
title2 = \
"""
                                                                                                    
                                                                                                    
DDDDDDDDDDDDD                                  tttt                 CCCCCCCCCCCCC   SSSSSSSSSSSSSSS 
D::::::::::::DDD                            ttt:::t              CCC::::::::::::C SS:::::::::::::::S
D:::::::::::::::DD                          t:::::t            CC:::::::::::::::CS:::::SSSSSS::::::S
DDD:::::DDDDD:::::D                         t:::::t           C:::::CCCCCCCC::::CS:::::S     SSSSSSS
  D:::::D    D:::::D    ooooooooooo   ttttttt:::::ttttttt    C:::::C       CCCCCCS:::::S            
  D:::::D     D:::::D oo:::::::::::oo t:::::::::::::::::t   C:::::C              S:::::S            
  D:::::D     D:::::Do:::::::::::::::ot:::::::::::::::::t   C:::::C               S::::SSSS         
  D:::::D     D:::::Do:::::ooooo:::::otttttt:::::::tttttt   C:::::C                SS::::::SSSSS    
  D:::::D     D:::::Do::::o     o::::o      t:::::t         C:::::C                  SSS::::::::SS  
  D:::::D     D:::::Do::::o     o::::o      t:::::t         C:::::C                     SSSSSS::::S 
  D:::::D     D:::::Do::::o     o::::o      t:::::t         C:::::C                          S:::::S
  D:::::D    D:::::D o::::o     o::::o      t:::::t    ttttttC:::::C       CCCCCC            S:::::S
DDD:::::DDDDD:::::D  o:::::ooooo:::::o      t::::::tttt:::::t C:::::CCCCCCCC::::CSSSSSSS     S:::::S
D:::::::::::::::DD   o:::::::::::::::o      tt::::::::::::::t  CC:::::::::::::::CS::::::SSSSSS:::::S
D::::::::::::DDD      oo:::::::::::oo         tt:::::::::::tt    CCC::::::::::::CS:::::::::::::::SS 
DDDDDDDDDDDDD           ooooooooooo             ttttttttttt         CCCCCCCCCCCCC SSSSSSSSSSSSSSS   
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
"""
title3 = \
"""

                                                                                                                                                                           
                                                                                                                                                                           
        CCCCCCCCCCCCC                                                                                                     iiii          tttt                               
     CCC::::::::::::C                                                                                                    i::::i      ttt:::t                               
   CC:::::::::::::::C                                                                                                     iiii       t:::::t                               
  C:::::CCCCCCCC::::C                                                                                                                t:::::t                               
 C:::::C       CCCCCC   ooooooooooo      mmmmmmm    mmmmmmm      mmmmmmm    mmmmmmm   uuuuuu    uuuuuunnnn  nnnnnnnn    iiiiiiittttttt:::::tttttttyyyyyyy           yyyyyyy
C:::::C               oo:::::::::::oo  mm:::::::m  m:::::::mm  mm:::::::m  m:::::::mm u::::u    u::::un:::nn::::::::nn  i:::::it:::::::::::::::::t y:::::y         y:::::y 
C:::::C              o:::::::::::::::om::::::::::mm::::::::::mm::::::::::mm::::::::::mu::::u    u::::un::::::::::::::nn  i::::it:::::::::::::::::t  y:::::y       y:::::y  
C:::::C              o:::::ooooo:::::om::::::::::::::::::::::mm::::::::::::::::::::::mu::::u    u::::unn:::::::::::::::n i::::itttttt:::::::tttttt   y:::::y     y:::::y   
C:::::C              o::::o     o::::om:::::mmm::::::mmm:::::mm:::::mmm::::::mmm:::::mu::::u    u::::u  n:::::nnnn:::::n i::::i      t:::::t          y:::::y   y:::::y    
C:::::C              o::::o     o::::om::::m   m::::m   m::::mm::::m   m::::m   m::::mu::::u    u::::u  n::::n    n::::n i::::i      t:::::t           y:::::y y:::::y     
C:::::C              o::::o     o::::om::::m   m::::m   m::::mm::::m   m::::m   m::::mu::::u    u::::u  n::::n    n::::n i::::i      t:::::t            y:::::y:::::y      
 C:::::C       CCCCCCo::::o     o::::om::::m   m::::m   m::::mm::::m   m::::m   m::::mu:::::uuuu:::::u  n::::n    n::::n i::::i      t:::::t    tttttt   y:::::::::y       
  C:::::CCCCCCCC::::Co:::::ooooo:::::om::::m   m::::m   m::::mm::::m   m::::m   m::::mu:::::::::::::::uun::::n    n::::ni::::::i     t::::::tttt:::::t    y:::::::y        
   CC:::::::::::::::Co:::::::::::::::om::::m   m::::m   m::::mm::::m   m::::m   m::::m u:::::::::::::::un::::n    n::::ni::::::i     tt::::::::::::::t     y:::::y         
     CCC::::::::::::C oo:::::::::::oo m::::m   m::::m   m::::mm::::m   m::::m   m::::m  uu::::::::uu:::un::::n    n::::ni::::::i       tt:::::::::::tt    y:::::y          
        CCCCCCCCCCCCC   ooooooooooo   mmmmmm   mmmmmm   mmmmmmmmmmmm   mmmmmm   mmmmmm    uuuuuuuu  uuuunnnnnn    nnnnnniiiiiiii         ttttttttttt     y:::::y           
                                                                                                                                                        y:::::y            
                                                                                                                                                       y:::::y             
                                                                                                                                                      y:::::y              
                                                                                                                                                     y:::::y               
                                                                                                                                                    yyyyyyy                
                                                                                                                                                                           
                                                                                                                                                                           
"""
title4 = \
"""
┌────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
|                                                                                                            |
|                                                                                                            |
|    DDDDDDDDDDDDD                                  tttt                 CCCCCCCCCCCCC   SSSSSSSSSSSSSSS     |
|    D::::::::::::DDD                            ttt:::t              CCC::::::::::::C SS:::::::::::::::S    |
|    D:::::::::::::::DD                          t:::::t            CC:::::::::::::::CS:::::SSSSSS::::::S    |
|    DDD:::::DDDDD:::::D                         t:::::t           C:::::CCCCCCCC::::CS:::::S     SSSSSSS    |
|      D:::::D    D:::::D    ooooooooooo   ttttttt:::::ttttttt    C:::::C       CCCCCCS:::::S                |
|      D:::::D     D:::::D oo:::::::::::oo t:::::::::::::::::t   C:::::C              S:::::S                |
|      D:::::D     D:::::Do:::::::::::::::ot:::::::::::::::::t   C:::::C               S::::SSSS             |
|      D:::::D     D:::::Do:::::ooooo:::::otttttt:::::::tttttt   C:::::C                SS::::::SSSSS        |
|      D:::::D     D:::::Do::::o     o::::o      t:::::t         C:::::C                  SSS::::::::SS      |
|      D:::::D     D:::::Do::::o     o::::o      t:::::t         C:::::C                     SSSSSS::::S     |
|      D:::::D     D:::::Do::::o     o::::o      t:::::t         C:::::C                          S:::::S    |
|      D:::::D    D:::::D o::::o     o::::o      t:::::t    ttttttC:::::C       CCCCCC            S:::::S    |
|    DDD:::::DDDDD:::::D  o:::::ooooo:::::o      t::::::tttt:::::t C:::::CCCCCCCC::::CSSSSSSS     S:::::S    |
|    D:::::::::::::::DD   o:::::::::::::::o      tt::::::::::::::t  CC:::::::::::::::CS::::::SSSSSS:::::S    |
|    D::::::::::::DDD      oo:::::::::::oo         tt:::::::::::tt    CCC::::::::::::CS:::::::::::::::SS     |
|    DDDDDDDDDDDDD           ooooooooooo             ttttttttttt         CCCCCCCCCCCCC SSSSSSSSSSSSSSS       |
|                                                                                                            |
|                                                                                                            |
|                                                                                                            |
|                           ____                                      _ _                                    |
|                          / ___|___  _ __ ___  _ __ ___  _   _ _ __ (_) |_ _   _                            |
|                         | |   / _ \| '_ ` _ \| '_ ` _ \| | | | '_ \| | __| | | |                           |
|                         | |__| (_) | | | | | | | | | | | |_| | | | | | |_| |_| |                           |
|                          \____\___/|_| |_| |_|_| |_| |_|\__,_|_| |_|_|\__|\__, |                           |
|                                                                           |___/                            |
└────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                  艺术字来源: http://patorjk.com/software/taag/#p=testall&t=DotCS%20Community                  
"""
print(\
"""





























Code: http://www.dotcs.community/code/version/""")
try:
    # 在控制台输出彩色文本的函数
    lastOutputLen = 0
    lastReplace = False
    lastReplaceByNext = False
    exiting = False
    def color(text: str, output: bool = True, end: str = "\n", replace: bool = False, show: bool = False, replaceByNext: bool = False) -> str:
        """
        在控制台输出彩色文本的函数

        参数:
            text: str -> 要输出的信息
            output: bool -> 是否在控制台输出
            end: str -> 输出时末尾的字符, 同print()
            replace: bool -> 是否以不能被下次输出替换, 但能被下次replace = True的输出替换的形式输出, 即在开头和末尾加上\r
            replaceByNext: bool -> 是否以能被下次输出替换的形式输出, 即在开头和末尾加上\r
        返回: str -> 输出
        """
        global lastOutputLen, lastReplace, lastReplaceByNext
        if text[-1] == "\n" and "Traceback" in text:
            text = text[:-1]
        if "报错, 信息:" in text:
            text = "§4"+text
        text = text.replace("§1", "\033[0;37;34m").replace("§2", "\033[0;37;32m").replace("§3", "\033[0;37;36m").replace("§4", "\033[0;37;31m").replace("§5", "\033[0;37;35m").replace("§6", "\033[0;37;33m").replace("§7", "\033[0;37;90m").replace("§8", "\033[0;37;2m").replace("§9", "\033[0;37;94m").replace("§a", "\033[0;37;92m").replace("§b", "\033[0;37;96m").replace("§c", "\033[0;37;91m").replace("§d", "\033[0;37;95m").replace("§e", "\033[0;37;93m").replace("§f", "\033[0;37;1m").replace("§r", "\033[0m")+"\033[0m"
        if output:
            if replace:
                text = "\r"+text+" "*(lastOutputLen-(len(text.replace("\033[0;37;34m", "").replace("\033[0;37;32m", "").replace("\033[0;37;36m", "").replace("\033[0;37;31m", "").replace("\033[0;37;35m", "").replace("\033[0;37;33m", "").replace("\033[0;37;90m", "").replace("\033[0;37;2m", "").replace("\033[0;37;94m", "").replace("\033[0;37;92m", "").replace("\033[0;37;96m", "").replace("\033[0;37;91m", "").replace("\033[0;37;95m", "").replace("\033[0;37;93m", "").replace("\033[0;37;1m", "").replace("\033[0m", ""))+(len(text.replace("\033[0;37;34m", "").replace("\033[0;37;32m", "").replace("\033[0;37;36m", "").replace("\033[0;37;31m", "").replace("\033[0;37;35m", "").replace("\033[0;37;33m", "").replace("\033[0;37;90m", "").replace("\033[0;37;2m", "").replace("\033[0;37;94m", "").replace("\033[0;37;92m", "").replace("\033[0;37;96m", "").replace("\033[0;37;91m", "").replace("\033[0;37;95m", "").replace("\033[0;37;93m", "").replace("\033[0;37;1m", "").replace("\033[0m", "").encode())-len(text.replace("\033[0;37;34m", "").replace("\033[0;37;32m", "").replace("\033[0;37;36m", "").replace("\033[0;37;31m", "").replace("\033[0;37;35m", "").replace("\033[0;37;33m", "").replace("\033[0;37;90m", "").replace("\033[0;37;2m", "").replace("\033[0;37;94m", "").replace("\033[0;37;92m", "").replace("\033[0;37;96m", "").replace("\033[0;37;91m", "").replace("\033[0;37;95m", "").replace("\033[0;37;93m", "").replace("\033[0;37;1m", "").replace("\033[0m", "")))//2))
                end = ""
                lastReplace = True
            else:
                if lastReplace:
                    if lastReplaceByNext:
                        text = "\r"+text+" "*(lastOutputLen-(len(text.replace("\033[0;37;34m", "").replace("\033[0;37;32m", "").replace("\033[0;37;36m", "").replace("\033[0;37;31m", "").replace("\033[0;37;35m", "").replace("\033[0;37;33m", "").replace("\033[0;37;90m", "").replace("\033[0;37;2m", "").replace("\033[0;37;94m", "").replace("\033[0;37;92m", "").replace("\033[0;37;96m", "").replace("\033[0;37;91m", "").replace("\033[0;37;95m", "").replace("\033[0;37;93m", "").replace("\033[0;37;1m", "").replace("\033[0m", ""))+(len(text.replace("\033[0;37;34m", "").replace("\033[0;37;32m", "").replace("\033[0;37;36m", "").replace("\033[0;37;31m", "").replace("\033[0;37;35m", "").replace("\033[0;37;33m", "").replace("\033[0;37;90m", "").replace("\033[0;37;2m", "").replace("\033[0;37;94m", "").replace("\033[0;37;92m", "").replace("\033[0;37;96m", "").replace("\033[0;37;91m", "").replace("\033[0;37;95m", "").replace("\033[0;37;93m", "").replace("\033[0;37;1m", "").replace("\033[0m", "").encode())-len(text.replace("\033[0;37;34m", "").replace("\033[0;37;32m", "").replace("\033[0;37;36m", "").replace("\033[0;37;31m", "").replace("\033[0;37;35m", "").replace("\033[0;37;33m", "").replace("\033[0;37;90m", "").replace("\033[0;37;2m", "").replace("\033[0;37;94m", "").replace("\033[0;37;92m", "").replace("\033[0;37;96m", "").replace("\033[0;37;91m", "").replace("\033[0;37;95m", "").replace("\033[0;37;93m", "").replace("\033[0;37;1m", "").replace("\033[0m", "")))//2))
                    else:
                        text = "\n"+text
                    lastReplace = False
            if replaceByNext:
                lastReplaceByNext = True
            else:
                lastReplaceByNext = False
            if (not exiting) or show:
                print(text, end = end)
            l = text.replace("\r", "").replace("\033[0;37;34m", "").replace("\033[0;37;32m", "").replace("\033[0;37;36m", "").replace("\033[0;37;31m", "").replace("\033[0;37;35m", "").replace("\033[0;37;33m", "").replace("\033[0;37;90m", "").replace("\033[0;37;2m", "").replace("\033[0;37;94m", "").replace("\033[0;37;92m", "").replace("\033[0;37;96m", "").replace("\033[0;37;91m", "").replace("\033[0;37;95m", "").replace("\033[0;37;93m", "").replace("\033[0;37;1m", "").replace("\033[0m", "").split("\n")[-1]
            if l:
                while l[-1] == " ":
                    l = l[:-1]
            lastOutputLen = len(l)+(len(l.encode())-len(l))//2
        else:
            return text


    # 导入库
    try:
        import os
        import traceback
        import socket
        import datetime
        import time
        import json
        import random
        import sys
        import urllib
        import urllib.parse
        import _thread as thread
        import requests
        import platform
        import psutil
        import sqlite3
        # 初始化变量
        pid = os.getpid()
        os.system("echo DotCS is running, pid is %d" % pid)
        platformVer = str(platform.platform()) # 检测系统版本
        if "Windows" in platformVer:
            platformVer = "Windows"
            outputTime = "long"
        else:
            platformVer = "Linux"
            outputTime = "short"
        from proxy import conn
    except Exception as err:
        if "robot.json" in os.listdir():
            os.system("rmdir /s /q proxy")
            os.system("mkdir proxy")
            os.system("curl --output proxy\\conn.py http://www.dotcs.community/code/proxy/conn.py")
            os.system("curl --output proxy\\fbconn.dll http://www.dotcs.community/code/proxy/fbconn.dll")
            os.system("curl --output proxy\\fbconn.h http://www.dotcs.community/code/proxy/fbconn.h")
            os.system("curl --output phoenixbuilder.exe http://www.dotcs.community/update/phoenixbuilder.exe")
            os.system("curl --output server.txt http://www.dotcs.community/update/server.txt")
            os.system("del runfb.cmd")
            os.system("del robot.json")
        color("§4导入Python库失败, 信息:\n"+str(err))
        color("§c"+traceback.format_exc())
        exit()

    class GetTimeoutError(Exception):
        pass

    class TargetNotFoundError(Exception):
        pass

    # 检测端口是否被占用的函数
    def is_port_used(port: int) -> bool:
        """
        检测端口是否被占用的函数

        参数:
            port: int -> 要检测的端口
        返回:
            端口未占用: bool -> False
            端口被占用: bool -> True
        """
        portUsed = False
        for proc in psutil.process_iter():
            try:
                if "phoenixbuilder.exe" == proc.name():
                    if strInList(str(port), proc.cmdline()):
                        portUsed = True
            except:
                pass
        return portUsed
    

    # 控制台显示倒计时的函数
    def countdown(delay: int | float, msg: str = None) -> None:
        """
        控制台显示倒计时的函数

        参数:
            delay: int | float -> 倒计时时间(秒)
            msg: str -> 倒计时运行时显示的说明
        返回: 无返回值
        """
        if msg is None:
            msg = "Countdown"
        delayStart = time.time()
        delayStop = delayStart+delay
        while delay >= 0.01:
            delay = delayStop-time.time()
            color("%s: %.2fs" % (msg, delay), replace = True, show = True, replaceByNext = True)
            time.sleep(0.01)


    
    # 退出命令系统的函数
    def exitChatbarMenu(killFB: bool = True, delay: int | float = 3, reason: str = None) -> None:
        """
        退出命令系统的函数

        参数:
            killFB: bool -> 是否同时关闭FastBuilder
            delay: int | float -> 倒计时时间(秒)
            reason: str -> 退出时显示的说明
        返回: 无返回值
        """
        global exiting
        if not exiting:
            if reason is None:
                color("§eExiting.")
            else:
                color("§eExiting, reason: %s" % str(reason))
            exiting = True
            if killFB:
                # color("§eKilling FB thread.")
                FBkill()
            if delay != 0:
                countdown(delay, "§eExiting")
            color("Exit.", replace = True, show = True)
            print()
            if platformVer == "Windows":
                # color("§eKilling DotCS thread.")
                os.system("taskkill /f /t /im %d" % pid)
            sys.exit()
            exit()


    # 关闭FB的函数
    def FBkill() -> None:
        """
        关闭FastBuilder的函数
        """
        if platformVer == "Windows":
            for proc in psutil.process_iter():
                try:
                    if "phoenixbuilder.exe" == proc.name():
                        if strInList(server, proc.cmdline()):
                            os.system("taskkill /f /pid %d" % proc.pid)
                            color("§6Killed FB thread, pid is %d" % proc.pid, show = True)
                except:
                    pass
        else:
            os.system("pkill phoenixbuilder")
        time.sleep(1)


    # 启动FB的函数
    def runFB(killFB: bool = True) -> None:
        """
        启动FastBuilder的函数

        参数:
            killFB: bool -> 启动前是否关闭FastBuilder
        返回: 无返回值
        """
        global platformVer, FBport
        if FBip == "localhost" or FBip == "127.0.0.1":
            color("Running FB program.")
            try:
                if platformVer == "Linux":
                    os.system("rm nohup.out")
                else:
                    os.system("del nohup.out")
                with open("nohup.out", "w") as file:
                    file.write("")
            except:
                FBkill()
                with open("nohup.out", "w") as file:
                    file.write("")
        if platformVer == "Windows":
            if killFB:
                FBkill()
            while is_port_used(FBport):
                color("§ePort %d is used, changing." % FBport)
                FBport += 1
            os.system('mshta vbscript:createobject("wscript.shell").run("""cmd.exe""/C phoenixbuilder.exe -t fbtoken --code %s --password %s --listen-external 0.0.0.0:%d --no-readline --no-update-check>nohup.out",0)(window.close)' % (server, serverPassword, FBport))
        else:
            if killFB:
                FBkill()
            os.system("nohup ./phoenixbuilder -t fbtoken --code %s --password %s --listen-external 0.0.0.0:8000 --no-readline --no-update-check &" % (server, serverPassword))


    # 重启FB的函数
    def restartFB() -> None:
        """
        重启FB的函数
        """
        global timeSpentFBRun, connID, reconnecting, timeStartFBRun, FBlog
        color("§eRestarting FB.")
        reconnecting = True
        FBkill()
        runFB()
        FBlog = FBlogRead()
        timeStartFBRun = time.time()
        color("§eWaiting for FB to connect to server %s, please wait." % server)
        try:
            if FBip == "localhost" or FBip == "127.0.0.1":
                while not(strInList("0.0.0.0:%d" % FBport, FBlog)):
                    timeSpentFBStart = time.time()-timeStartFBRun
                    color("§eConnecting..., %.2fs/20s" % timeSpentFBStart, replace = True, replaceByNext = True)
                    if timeSpentFBStart >= 20:
                        color("§4FB超过20秒未连接上租赁服, 正在退出.")
                        raise Exception("timed out")
                    time.sleep(0.01)
                time.sleep(1)
                connID = conn.ConnectFB("%s:%d" % (FBip, FBport))
                color("§aReconnected to FB program.")
            reconnecting = False
        except:
            color("§4Cannot restart FB, exiting.")
            exitChatbarMenu()


    def Byte2KB(byteSize: int) -> str:
        """
        将字节单位转换为最大能转换的单位的函数

        参数:
            byteSize: int -> 字节单位大小
        返回: str: -> 转换后的格式
        """
        for i in ["B", "KB", "MB", "GB", "TB", "PB", "EB"]:
            if byteSize > 1024:
                byteSize /= 1024
            else:
                return "%.2f%s" % (byteSize, i)


    def fileDownload(url: str, path: str, timeout: float | int = 3, freshSize: int = 10240) -> dict:
        """
        下载文件并显示进度的函数

        参数:
            url: str -> 文件链接
            path: str -> 文件存储位置
            timeout: float | int -> 下载超时处理, 单位: 秒
            freshSize: int -> 每次下载的文件大小, 单位: 字节, 说明: 此数值越大, 对CPU的使用越低, 控制台更新下载进度状态的频率也越慢
        返回:
            dict: -> 下载是否成功
                成功: status -> success
                失败: status -> fail
                    无法找到目标服务器: reason -> file not found
                    目标服务器拒绝下载: reason -> server rejected
                    下载时连接中断或超时: reason -> timed out
        """
        try:
            response = requests.get(url, stream = True, timeout = timeout)
        except Exception as err:
            color("§4Failed to download, reason: file not found")
            return {"status": "fail", "reason": "file not found"}
        fileDownloadedSize = 0
        fileSize = int(response.headers['content-length'])
        if response.status_code == 200:
            color("§eStarting download, file size: %s" % Byte2KB(fileSize))
            timeDownloadStart = time.time()
            fileDownloadedLastSize = 0
            speedDownloadCurrent = 0
            with open(path, 'wb') as file:
                try:
                    for data in response.iter_content(chunk_size = freshSize):
                        file.write(data)
                        fileDownloadedSize += len(data)
                        if time.time()-timeDownloadStart >= 0.5:
                            speedDownloadCurrent = (fileDownloadedSize-fileDownloadedLastSize)/(time.time()-timeDownloadStart)
                            timeDownloadStart = time.time()
                            fileDownloadedLastSize = fileDownloadedSize
                        color("§eDownloading: %.2f%%, %s / %s, %s/s" % (fileDownloadedSize/fileSize*100, Byte2KB(fileDownloadedSize), Byte2KB(fileSize), Byte2KB(speedDownloadCurrent)), replace = True)
                except Exception as err:
                    color("§4Failed to download, reason: timed out")
                    return {"status": "fail", "reason": "timed out"}
            color("§aFinished download")
            return {"status": "success"}
        else:
            color("§4Failed to download, reason: status code is %s" % response.status_code)
            return {"status": "fail", "reason": "server rejected", "status_code": response.status_code}


    # 检测更新函数, 若有更新则自动下载
    def updateCheck() -> None:
        """
        检测命令系统更新的函数, 若有更新则自动下载
        你不应该使用此函数, 命令系统会在启动时运行一次, 启动成功后每60s运行一次
        """
        if not(connected):
            color("§eChecking updates. Your version: %s" % version)
        try:
            status = requests.get("http://chatbar.menu/status.txt", timeout=5)
            status.encoding = "GBK"
            status = status.text.split("\r\n")
            newversion = status[0].split("version: ")[1]
            allow = status[1].split("allow: ")[1]
        except:
            color("§4检测更新失败, 跳过检测.")
            newversion = version
            allow = "true"
        if newversion != version:
            color("§eLatest version: %s, downloading." % newversion)
            time.sleep(1)
            if platformVer == "Windows":
                if fileDownload("http://www.dotcs.community/robot.exe", "robot_new.exe")["status"] == "success":
                    time.sleep(0.1)
                    if os.path.isfile("robot_old.exe") == True:
                        os.system("del robot_old.exe")
                        time.sleep(0.1)
                    os.system("ren robot.exe robot_old.exe")
                    time.sleep(0.1)
                    os.system("ren robot_new.exe robot.exe")
                    color("§aFinished, restarting.")
                    exitChatbarMenu(reason = "Auto updating")
                else:
                    exitChatbarMenu(reason = "Download failed")
        else:
            if not(connected):
                color("§aYou are running the latest version.")
        if allow == "false":
            reason = status[2].split("msg: ")[1].replace(r"\n", "\n")
            color("§4%s" % reason)
            if not(connected):
                exitChatbarMenu(killFB = False)
            else:
                exitChatbarMenu()


    def updateSizeTell() -> None:
        """
        更新命令系统时在控制台显示已下载文件大小的函数
        """
        color("§eConnecting to http://www.dotcs.community/robot.exe.")
        while not ("robot.exe" in os.listdir()):
            time.sleep(0.1)
        color("§eReceiving file.")
        while True:
            try:
                color("§eDownloaded: %dKB." % (os.path.getsize("robot.exe")/1024), replace = True, replaceByNext = True)
            except:
                pass
            finally:
                time.sleep(0.1)


    # 检测你的租赁服号有没有被命令系统封禁, 若封禁则退出
    def blackListCheck() -> None:
        """
        检测你的租赁服号有没有被命令系统封禁, 若封禁则退出
        你不应该使用此函数, 命令系统会在启动时运行一次, 启动成功后每60s运行一次
        """
        if not(connected):
            color('§eChecking whether your server number is blocked by ".Dot" Command System - Netease Minecraft Server Chatbar Menu,\nYour server number: %s\nLocal time: %s' % (server, datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")))
        timeGetStart = time.time()
        try:
            result = requests.get("http://chatbar.menu:7913/api?type=serverNumberBanSearch&serverNumber=%s&versionDotCS=%s" % (server, version), timeout = 5).json()
            timeGetSpent = float(time.time()-timeGetStart)*1000
            if not(connected):
                color('§eServer time: %s' % result["time"])
                color('§eYour IP: %s' % result["ip"])
        except Exception as err:
            color("§4检测封禁失败, 跳过检测, 原因: "+str(err))
            result = {"status": "succeed", "ban": "no"}
            timeGetSpent = 9999999.99
        if result["status"] == "succeed":
            if result["ban"] == "yes":
                color('§4Your server number is blocked by ".Dot" Command System - Netease Minecraft Server Chatbar Menu, exiting.')
                color('§4你已被 ".命令"系统 官方封禁, 详情请询问7912或art,\n原因: %s' % result["reason"])
                exitChatbarMenu(killFB = False, delay = 60)
            elif result["ban"] == "no":
                if not(connected):
                    color("§aPassed, %.2fms" % timeGetSpent)
        else:
            color("§4检测封禁失败, 跳过检测, 原因: 命令系统服务器发生错误.")


    # 记录日志函数
    sendtogroup = ""
    QQgroup = ""
    def log(text: str, filename: str = None, mode: str = "a", encoding: str = "utf-8", errors: str = "ignore", output: bool = True, sendtogamewithRitBlk: bool = False, sendtogamewithERROR: bool = False, sendtogrp: bool = False) -> None:
        """
        记录日志的函数

        参数:
            text: str -> 要记录的信息
            filename: str -> 写入文件位置, 默认写入在 serverMsg\%Y-%m-%d.txt
            mode: str -> 记录方法, 同open()
            encoding: str -> 记录编码, 同open()
            errors: str -> 错误处理方式, 同open()
            output: bool -> 是否同时在控制台输出
        返回: 无返回值
        """
        if filename is None:
            filename = "serverMsg\\"+datetime.datetime.now().strftime("%Y-%m-%d.txt")
        if platformVer != "Windows":
            filename = filename.replace(r"\\", "/")
        if text[-1:] == "\n":
            text = text[:-1]
        if output:
            if outputTime == "long":
                color("["+datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")+"] "+text+"\033[0m")
            elif outputTime == "short":
                color("["+datetime.datetime.now().strftime("%H:%M:%S")+"] "+text+"\033[0m")
            else:
                color(text+"\033[0m")
        try:
            with open(filename, mode, encoding = encoding, errors = errors) as file:
                file.write("["+datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")+"] "+text+"\n")
        except Exception as err:
            print("写入日志错误, 信息:\n"+str(err))
        if sendtogamewithRitBlk and connected:
            sendcmd(r"""/tellraw @a {"rawtext":[{"text":"<§l§6Ritle§aBlock§r> %s"}]}""" % text.replace('"', '’’').replace("'", '’'))
        if sendtogamewithERROR and connected:#如果报错则执行
            sendcmd("""/tellraw @a {"rawtext":[{"text":"<§l§4ERROR§r> §c"""+text.replace('"', '’’').replace("'", '’')+""""}]}""")
        if sendtogrp:
            try:
                sendtogroup("group", QQgroup, text)
            except Exception as err:
                errmsg = "log()方法中sendtogroup()报错, 信息:\n"+str(err)
                log(errmsg)


    # 便捷执行tellraw的函数
    def tellrawText(who: str, dispname: None | str = None, text: str = None) -> None:
        """
        便捷执行tellraw的函数

        参数:
            who: str.MinecraftTargetSelector -> 给谁显示
            dispname: None | str -> 模拟玩家说话格式, 不传则直接tellraw
            text: str -> 要显示的信息
        返回: 无返回值
        """
        if dispname is None:
            sendcmd(r"""/tellraw %s {"rawtext":[{"text":"%s"}]}""" % (who, text.replace('"', '’’').replace("'", '’')))
        else:
            sendcmd(r"""/tellraw %s {"rawtext":[{"text":"<%s> %s"}]}""" % (who, dispname.replace('"', '’’').replace("'", '’'), text.replace('"', '’’').replace("'", '’')))


    # 返回tellraw计分板格式的函数
    def tellrawScore(scoreboardName: str, targetName: str) -> str:
        """
        返回tellraw计分板格式的函数

        参数:
            scoreboardName: str -> 计分板名称
            targetName: str -> 计分板对象
        返回: str -> tellraw计分板格式
        """
        return '{"score":{"name":"%s","objective":"%s"}}' % (targetName, scoreboardName)


    # 命令系统启动后每秒调用1次的函数
    # 请尽量不要存入费时间的代码, 否则影响准确度
    def repeating() -> None:
        """
        命令系统启动后每秒运行1次的函数
        你不应该使用此函数, 命令系统会自动以新线程运行它
        """
        global FBlog
        time.sleep(4)
        while True:
            try:
                FBlog = FBlogRead()
                for i in repeat1s_runcode:
                    try:
                        exec(i)
                    except Exception as err:
                        errmsg = "repeat1s插件: %s 报错, 信息:\n%s" % (i.split("\n")[0][1:], str(err))
                        log(errmsg, sendtogamewithERROR = True)
                        color("§c"+traceback.format_exc())
            except Exception as err:
                errmsg = "repeating()方法报错, 信息:\n"+str(err)
                log(errmsg, sendtogamewithERROR = True)
            finally:
                time.sleep(1)


    # 命令系统启动后每10秒调用1次的函数
    # 请尽量不要存入费时间的代码, 否则影响准确度
    def repeating3() -> None:
        """
        命令系统启动后每10秒运行1次的函数
        你不应该使用此函数, 命令系统会自动以新线程运行它
        """
        global allplayers
        time.sleep(5)
        allplayers = getTarget("@a")
        while True:
            try:
                for i in repeat10s_runcode:
                    try:
                        exec(i)
                    except Exception as err:
                        errmsg = "repeat10s插件: %s 报错, 信息:\n%s" % (i.split("\n")[0][1:], str(err))
                        log(errmsg, sendtogamewithERROR = True)
                        color("§c"+traceback.format_exc())
            except Exception as err:
                errmsg = "repeating3()方法报错, 信息:\n"+str(err)
                log(errmsg, sendtogamewithERROR = True)
            finally:
                time.sleep(10)


    # 命令系统启动后每60秒调用1次的函数
    # 请尽量不要存入费时间的代码, 否则影响准确度
    def repeating4() -> None:
        """
        命令系统启动后每60秒运行1次的函数
        你不应该使用此函数, 命令系统会自动以新线程运行它
        """
        global timesErr, allplayers
        time.sleep(2)
        while True:
            try:
                timesErr = 0
                allplayers = getTarget("@a")
                updateCheck()
                if server != 12345678:
                    if getStatus("report") != "off":
                        requests.get("http://www.dotcs.community:7913/api?type=serverRunningReport&serverNumber=%s&playerNumber=%d" % (server, len(allplayers)-1), timeout=5)
            except Exception as err:
                pass
                # errmsg = str(err)
                # log(errmsg)
            finally:
                time.sleep(60)


    # 获取玩家本地数据
    def getPlayerData(dataName: str, playerName: str, writeNew: str = "0") -> (str | int | float):
        """
        获取玩家本地数据的函数
        读取文件: player\playerName\dataName.txt

        参数:
            dataName: str -> 数据名称
            playerName: str -> 玩家名称
            writeNew: str -> 若数据不存在, 写入的数据
        返回: str | int | float -> 文件读取结果
        """
        try:
            if platformVer == "Windows":
                if playerName not in os.listdir("player"):
                    os.mkdir("player\\%s" % playerName)
                if "%s.txt" % dataName not in os.listdir("player\\%s\\" % playerName):
                    with open("player\\%s\\%s.txt" % (playerName, dataName), "w", encoding = "utf-8", errors = "ignore") as file:
                        file.write(writeNew)
                with open("player\\%s\\%s.txt" % (playerName, dataName), "r", encoding = "utf-8", errors = "ignore") as file:
                    data = file.read()
                    if "." not in data:
                        try:
                            data = int(data)
                        except:
                            pass
                    else:
                        try:
                            data = float(data)
                        except:
                            pass
            else:
                if playerName not in os.listdir("player"):
                    os.mkdir("player/%s" % playerName)
                if "%s.txt" % dataName not in os.listdir("player/%s/" % playerName):
                    with open("player/%s/%s.txt" % (playerName, dataName), "w", encoding = "utf-8", errors = "ignore") as file:
                        file.write(writeNew)
                with open("player/%s/%s.txt" % (playerName, dataName), "r", encoding = "utf-8", errors = "ignore") as file:
                    data = file.read()
                    if "." not in data:
                        try:
                            data = int(data)
                        except:
                            pass
                    else:
                        try:
                            data = float(data)
                        except:
                            pass
            return data
        except Exception as err:
            errmsg = "getPlayerData()方法报错, 信息:\n"+str(err)
            log(errmsg, sendtogamewithERROR = True)
            raise Exception(str(err))

    def setPlayerData(dataName: str, playerName: str, dataValue, writeNew: str = "0"):
        """
        设置玩家本地数据的函数
        写入文件: player\playerName\dataName.txt

        参数:
            dataName: str -> 数据名称
            playerName: str -> 玩家名称
            dataValue: Any -> 要设置的数据, 写入前会自动转化为str
            writeNew: str -> 若数据不存在, 写入的数据
        返回: dataValue: Any -> 设置结果
        """
        try:
            if platformVer == "Windows":
                if playerName not in os.listdir("player"):
                    os.mkdir("player\\%s" % playerName)
                if "%s.txt" % dataName not in os.listdir("player\\%s\\" % playerName):
                    with open("player\\%s\\%s.txt" % (playerName, dataName), "w", encoding = "utf-8", errors = "ignore") as file:
                        file.write(writeNew)
                with open("player\\%s\\%s.txt" % (playerName, dataName), "w", encoding = "utf-8", errors = "ignore") as file:
                    file.write(str(dataValue))
            else:
                if playerName not in os.listdir("player"):
                    os.mkdir("player/%s" % playerName)
                if "%s.txt" % dataName not in os.listdir("player/%s/" % playerName):
                    with open("player/%s/%s.txt" % (playerName, dataName), "w", encoding = "utf-8", errors = "ignore") as file:
                        file.write(writeNew)
                with open("player/%s/%s.txt" % (playerName, dataName), "w", encoding = "utf-8", errors = "ignore") as file:
                    file.write(str(dataValue))
            return dataValue
        except Exception as err:
            errmsg = "setPlayerData()方法报错, 信息:\n"+str(err)
            log(errmsg, sendtogamewithERROR = True)
            raise Exception(str(err))

    def addPlayerData(dataName: str, playerName: str, dataValue, dataType: str = "int", writeNew: str = "0"):
        """
        增加/追加玩家本地数据的函数
        写入文件: player\playerName\dataName.txt

        参数:
            dataName: str -> 数据名称
            playerName: str -> 玩家名称
            dataValue: Any -> 要设置的数据, 写入前会自动转化为str
            dataType: "int" | "add" -> 设置类型
                add: 在文件末尾追加
                int: 数学计算, 加上新值
            writeNew: str -> 若数据不存在, 写入的数据
        返回: dataValue: Any -> 设置结果
        """
        try:
            if dataType == "int":
                return setPlayerData(dataName, playerName, getPlayerData(dataName, playerName)+dataValue, writeNew)
            elif dataType == "add":
                if platformVer == "Windows":
                    with open("player\\%s\\%s.txt" % (playerName, dataName), "a", encoding = "utf-8", errors = "ignore") as file:
                        file.write("%s\n" % str(dataValue))
                else:
                    with open("player/%s/%s.txt" % (playerName, dataName), "a", encoding = "utf-8", errors = "ignore") as file:
                        file.write("%s\n" % str(dataValue))
                return dataValue
            else:
                raise Exception("dataType error")
        except Exception as err:
            errmsg = "addPlayerData()方法报错, 信息:\n"+str(err)
            log(errmsg, sendtogamewithERROR = True)
            raise Exception(str(err))


    # 返回变量类型
    def getType(sth):
        return type(sth).__name__


    # 小数转整数
    def float2int(number: float, way: int = 1) -> int:
        """
        小数转整数的函数

        参数:
            number: float -> 要转换的小数
            way: 1 | 2 | 3 -> 转换方式
                1: 四舍五入
                2: 舍去小数部分
                3: 若有小数部分, 则入
        返回: int -> 转换结果
        """
        if way == 1:
            return round(number)
        elif way == 2:
            return int(number)
        elif way == 3:
            if int(number) == number:
                return int(number)
            else:
                return int(number)+1


    # 获取对应选择器实体并返回列表.
    # 例:
    #   a = getTarget("@a")
    #   print(a)
    # 输出:
    #   ["player1", "player2", ...]
    # 请不要频繁使用
    def getTarget(sth: str) -> list:
        """
        获取租赁服内对应目标选择器实体的函数

        参数:
            sth: str.MinecraftTargetSelector -> 要获取的目标选择器
        返回: list -> 获取结果
        """
        global needToGet, target
        timeStartGet = time.time()
        target = sth
        needToGet = True
        sendcmd("/tell @s getting "+target)
        while True:
            if int(time.time() - timeStartGet) > 1:
                needToGet = False
                raise Exception("timed out")
            if not(needToGet):
                return target
            time.sleep(0.05)


    # 获取对应计分板数值并返回.
    # 例:
    # 假设玩家 7912mail 在 coin 计分板上的分数是 15
    #   a = getScore("coin", "7912mail")
    #   print(a)
    # 输出:
    #   15
    # 请不要频繁使用
    def getScore(scoreboardName: str, targetName: str) -> int:
        """
        获取租赁服内对应计分板数值的函数

        参数:
            scoreboardName: str -> 计分板名称
            targetName: str -> 计分板对象名称
        返回: int -> 获取结果
        """
        global needToGetScore, score
        timeStartGetScore = time.time()
        score = targetName
        needToGetScore = True
        sendcmd('/tellraw @s {"rawtext":[{"text":"getting "}, {"score":{"name":"%s","objective":"%s"}}]}' % (targetName, scoreboardName))
        while True:
            if int(time.time() - timeStartGetScore) > 1:
                needToGetScore = False
                raise GetTimeoutError("timed out")
            if not(needToGetScore):
                try:
                    score = int(score)
                except:
                    raise Exception("failed to get, maybe the target has no score or the scoreboard doesn't exist.")
                return score
            time.sleep(0.05)


    # 获取玩家坐标并返回.
    def getPos(targetName: str) -> dict:
        """
        获取租赁服内玩家坐标的函数

        参数:
            targetName: str -> 玩家名称
        返回: dict -> 获取结果
        """
        global needToGetPos, targPosList
        if targetName not in allplayers and "@a[" not in targetName:
            raise TargetNotFoundError("player not found")
        timeStartGetPos = time.time()
        needToGetPos = True
        if "@a[" in targetName:
            sendcmd("querytarget %s" % targetName)
        else:
            sendcmd("querytarget @a[name=%s]" % targetName)
        while True:
            if int(time.time() - timeStartGetPos) > 1:
                needToGetPos = False
                raise GetTimeoutError("timed out")
            if not(needToGetPos):
                return targPosList
            time.sleep(0.05)


    # 获取玩家某物品数量并返回.
    def getItem(targetName: str, itemName: str, itemSpecialID: int = -1) -> int:
        """
        获取租赁服内玩家某物品个数的函数

        参数:
            targetName: str -> 玩家名称
            itemName: str -> 物品英文名称
            itemSpecialID: int -> 物品特殊值
        返回: int -> 获取结果
        """
        global needToGetItem, haveItem
        if targetName not in allplayers:
            raise TargetNotFoundError("player not found")
        timeStartGetItem = time.time()
        haveItem = 0
        needToGetItem = True
        sendcmd("/clear %s %s %d 0" % (targetName, itemName, itemSpecialID))
        while True:
            if int(time.time() - timeStartGetItem) > 1:
                needToGetItem = False
                raise TimeoutError("timed out")
            if not(needToGetItem):
                return int(haveItem)
            time.sleep(0.05)


    # 记录或获取状态的函数
    def getStatus(statusName: str) -> str:
        """
        获取状态数据的函数
        读取文件: status\statusName.txt

        参数:
            statusName: str -> 数据名称
        返回: str -> 文件读取结果
        """
        try:
            if statusName+".txt" not in os.listdir("status"):
                pass
            if platformVer == "Windows":
                file = open("status\\%s.txt" % statusName, "r", encoding = "utf-8", errors = "ignore")
            else:
                file = open("status/%s.txt" % statusName, "r", encoding = "utf-8", errors = "ignore")
            status = file.read()
        except:
            status = "获取失败"
            errmsg = "getStatus()方法报错, 信息:\n"+str(err)
            log(errmsg, sendtogamewithERROR = True)
        finally:
            try:
                file.close()
            except:
                pass
            finally:
                return status

    def setStatus(statusName: str, status):
        """
        设置状态数据的函数
        设置文件: status\statusName.txt

        参数:
            statusName: str -> 数据名称
            status: Any -> 要写入的信息, 写入前会转化为str
        返回: Any -> 设置结果
        """
        try:
            if platformVer == "Windows":
                file = open("status\\%s.txt" % statusName, "w", encoding = "utf-8", errors = "ignore")
            else:
                file = open("status/%s.txt" % statusName, "w", encoding = "utf-8", errors = "ignore")
            file.write(str(status))
        except Exception as err:
            status = "设置失败"
            errmsg = "setStatus()方法报错, 信息:\n"+str(err)
            log(errmsg, sendtogamewithERROR = True)
        finally:
            try:
                file.close()
            except:
                pass
            finally:
                return status


    # 命令系统启动后玩家每发一条信息就调用1次的函数
    def msgPlayerSend(playername: str, msg: str) -> None:
        """
        命令系统启动后玩家每发一条信息就运行1次的函数
        你不应该使用此函数, 命令系统会自动在收到玩家发出的信息时运行1次
        """
        try:
            for i in range(1, 100):
                exec("global tp_%d, tp_%d_time, tp_%d_time_use" % (i, i, i))
            for i in cmds_runcode:
                try:
                    exec(i)
                except Exception as err:
                    errmsg = "cmdsrun插件: %s 报错, 信息:\n%s" % (i.split("\n")[0][1:], str(err))
                    log(errmsg, sendtogamewithERROR = True)
                    color("§c"+traceback.format_exc())
            try:
                if playername in adminhigh:
                    if ".exec " in msg:
                        #游戏内执行Python代码
                        #格式: .exec <语句>
                        #例:
                        #   .exec print("art")
                        #后台:
                        #   art
                        try: #分割字符串并执行
                            exec(msg.split(".exec ")[1].replace(r"\n", "\n"))
                            tellrawText(playername, "§l§6Python§r", "已尝试执行.")
                        except Exception as err:
                            errmsg = "游戏内Python报错, 信息:\n"+str(err)
                            log(errmsg, sendtogamewithERROR = True)
                            color("§c"+traceback.format_exc())
                    if ".getvar " in msg: #提示游戏内的变量
                        try:
                            varr = msg.split(".getvar ")[1]
                            sendmsg = "变量 "+str(varr)+" 的值是: "+str(eval(varr))
                            print(sendmsg)
                            sendcmd(r"""/tellraw @a {"rawtext":[{"text":"<§l§6Python§r> """+sendmsg+""""}]}""")
                        except Exception as err:
                            errmsg = "游戏内Python报错, 信息:\n"+str(err)
                            log(errmsg, sendtogamewithERROR = True)
                            color("§c"+traceback.format_exc())
            except:
                pass
        except Exception as err: #程序报错了
            errmsg = "cmds()方法报错, 信息:\n"+str(err)
            log(errmsg, sendtogamewithERROR = True)
        finally:
            pass


    # 命令系统启动后玩家死亡时调用1次的函数
    def msgPlayerDeath(playername: str, msg: str, killer: str) -> None:
        """
        命令系统启动后玩家死亡时运行1次的函数
        你不应该使用此函数, 命令系统会自动在玩家死亡时运行1次
        """
        try:
            for i in death_runcode:
                exec(i)
        except Exception as err:
            errmsg = "death插件报错, 信息:\n"+str(err)
            log(errmsg, sendtogamewithERROR = True)
            color("§c"+traceback.format_exc())


    # 命令系统启动后玩家加入时调用1次的函数
    def msgPlayerJoin(playername: str, msg: str) -> None:
        """
        命令系统启动后玩家加入租赁服时运行1次的函数
        你不应该使用此函数, 命令系统会自动在玩家加入租赁服时运行1次
        """
        try:
            try:
                int(playername)
                sendcmd('/kick "%s" §c抱歉, 因命令系统(DotCS Community)作者7912技术不足, 暂不允许数字开头的玩家进服.' % playername)
            except:
                pass
            for i in join_runcode:
                exec(i)
        except Exception as err:
            errmsg = "join插件: %s 报错, 信息:\n%s" % (i.split("\n")[0][1:], str(err))
            log(errmsg, sendtogamewithERROR = True)
            color("§c"+traceback.format_exc())


    # 命令系统启动后玩家退出时调用1次的函数
    def msgPlayerLeave(playername: str, msg: str) -> None:
        """
        命令系统启动后玩家退出租赁服时运行1次的函数
        你不应该使用此函数, 命令系统会自动在玩家退出租赁服时运行1次
        """
        try:
            for i in left_runcode:
                exec(i)
        except Exception as err:
            errmsg = "left插件: %s 报错, 信息:\n%s" % (i.split("\n")[0][1:], str(err))
            log(errmsg, sendtogamewithERROR = True)
            color("§c"+traceback.format_exc())


    # 发送指令到租赁服的函数
    def sendcmd(cmd: str) -> None:
        """
        以Web Socket身份发送指令到租赁服的函数

        参数:
            cmd: str.MinecraftCommand -> 要在租赁服执行的指令
        返回: 无返回值
        """
        try:
            if cmd[0] == "/":
                cmd = cmd[1:]
            conn.SendMCCommand(connID, cmd)
        except Exception as err:
            if not reconnecting:
                errmsg = "sendcmd()方法报错, 信息:\n"+str(err)
                log(errmsg)
            # exitChatbarMenu()
    def sendwscmd(cmd: str) -> None:
        """
        以玩家(FastBuilder机器人)身份发送指令到租赁服的函数

        参数:
            cmd: str.MinecraftCommand -> 要在租赁服执行的指令
        返回: 无返回值
        """
        try:
            if cmd[0] == "/":
                cmd = cmd[1:]
            conn.SendWSCommand(connID, cmd)
        except Exception as err:
            errmsg = "sendwscmd()方法报错, 信息:\n"+str(err)
            log(errmsg)
            # exitChatbarMenu()
    def sendwocmd(cmd: str) -> None:
        """
        以最高权限(租赁服控制台)身份发送指令到租赁服的函数
        警告: 你可以执行 /stop, 这会导致租赁服关闭, 然后重启

        参数:
            cmd: str.MinecraftCommand -> 要在租赁服执行的指令
        返回: 无返回值
        """
        try:
            if cmd[0] == "/" or cmd[0] == "!":
                cmd = cmd[1:]
            conn.SendNoResponseCommand(connID, cmd)
        except Exception as err:
            if not reconnecting:
                errmsg = "sendwocmd()方法报错, 信息:\n"+str(err)
                log(errmsg)
            # exitChatbarMenu()


    # 发送命令到FastBuilder的函数
    def sendfbcmd(cmd: str) -> None:
        """
        发送命令到FastBuilder的函数

        参数:
            cmd: str.FastBuilderCommand -> FastBuilder执行指令
        返回: 无返回值
        """
        try:
            if cmd[0] == "?":
                cmd = cmd[1:]
            conn.SendFBCommand(connID, cmd)
        except Exception as err:
            errmsg = "sendfbcmd()方法报错, 信息:\n"+str(err)
            log(errmsg)
            exitChatbarMenu()


    # 解密加密后的插件的函数
    def pluginDec(code: str) -> str:
        """
        解密插件的函数
        你不应该使用此函数, 命令系统会在加载加密过的插件时自动运行此函数
        """
        codeDecoded = ""
        codeLen = len(code)
        codeNow = 0
        for i in code:
            codeNow += 1
            codePCT = codeNow/codeLen*100
            codeDecoded += chr(ord(i)-1)
            if i == "\r" or i == "\n":
                color("§eDecoding: \\n, %.2f%s, %d/%d" % (codePCT, "%", codeNow, codeLen), replace = True)
            else:
                color("§eDecoding: %s, %.2f%s, %d/%d" % (i, codePCT, "%", codeNow, codeLen), replace = True)
            if random.randint(1, 50) == 1:
                time.sleep(0.001)
        color("\n§aFinished.", replace = True)
        return codeDecoded


    # 加密插件的函数
    def pluginEnc(code: str) -> str:
        """
        加密插件的函数
        你不应该使用此函数, 命令系统也不会用到此函数
        """
        codeEncoded = ""
        codeLen = len(code)
        codeNow = 0
        for i in code:
            codeNow += 1
            codePCT = codeNow/codeLen*100
            codeEncoded += chr(ord(i)+1)
            if i == "\r" or i == "\n":
                color("§eEncoding: \\n, %.2f%s, %d/%d" % (codePCT, "%", codeNow, codeLen), replace = True)
            else:
                color("§eEncoding: %s, %.2f%s, %d/%d" % (i, codePCT, "%", codeNow, codeLen), replace = True)
            if random.randint(1, 50) == 1:
                time.sleep(0.001)
        color("\n§aFinished.", replace = True)
        return codeEncoded


    # 读取FastBuilder日志的函数
    FBlog_old = []
    def FBlogRead() -> str:
        """
        读取FastBuilder日志的函数
        你不应该使用此函数, 命令系统会每秒运行1次此函数
        """
        if FBip == "localhost" or FBip == "127.0.0.1":
            global FBlog_old
            try:
                with open("nohup.out", "r", encoding = "utf-8") as file:
                    FBlog = file.readlines()
                    FBlogNew = []
                    for i in range(len(FBlog)):
                        try:
                            FBlog[i] = FBlog[i].replace("\n", "").replace("\r", "")
                        except:
                            pass
                    if FBlog != FBlog_old:
                        for i in FBlog:
                            if i not in FBlog_old:
                                FBlogNew.append(i)
                    if FBlogNew != []:
                        for i in FBlogNew:
                            color("[§6FB output§r] %s§r" % i)
                        if strInList("ERROR", FBlogNew):
                            if strInList("Unauthorized rental server number", FBlogNew) or strInList("对应租赁服号尚未授权", FBlogNew):
                                with open("server.txt", "r") as file:
                                    FBconfig = eval(file.read().replace("false","False").replace("true","True"))
                                    FBconfig["serverNumber"] = input("请重新输入服号: ")
                                    if FBconfig["serverNumber"] == "":
                                        raise Exception("Netease server number error")
                                with open("server.txt", "w") as file:
                                    file.write(str(FBconfig).replace("False","false").replace("True","true").replace("'", '"'))
                                color("§a成功设置服号")
                            if connected:
                                FBkill()
                                # restartFB()
                            else:
                                exitChatbarMenu()
                    FBlog_old = FBlog
                    return FBlog
            except Exception as err:
                if str(err) == "Netease server number error":
                    raise Exception("Netease server number error")
        return False


    # 检测字符串是否在列表里的函数
    def strInList(str: str, list: list) -> bool:
        """
        检测字符串是否在列表里的函数

        参数:
            str: str -> 要检测的字符串
            list: list -> 要检测的列表
        返回:
            若str在list里: bool -> True
            若str不在list里: bool -> False
        """
        inList = False
        for i in list:
            if str in i:
                inList = True
                break
        return inList


    # 处理FastBuilder发送来的包的函数
    msgList = []
    rev = ""
    playername = ""
    target = ""
    allplayers = []
    allplayers_old = []
    robotname = ""
    timesErr = 0
    msgRecved = False
    entityRuntimeID2playerName = {}
    XUID2playerName = {}
    msgLastRecvTime = time.time()
    itemNetworkID2NameDict = {}
    itemNetworkID2NameEngDict = {}
    adminhigh = []
    def processMsg() -> None:
        """
        处理FastBuilder发送来的包的函数
        你不应该使用此函数, 命令系统会在运行FastBuilder后以新线程启动此函数
        """
        global msgLastRecvTime, XUID2playerName, entityRuntimeID2playerName, timeSpentFBRun, msgRecved, msgList, needToGet, target, server, connected, server, connID, timeGameH, timeGameM, timeGameHstr, timeGameMstr, timesErr, robotname, needToGetScore, score, needToGetPos, targPosList, haveItem, needToGetItem, allplayers, needToGetMainhandItem, itemMainhand, needToGetArmorItem, itemArmor, needToGetMainhandAndArmorItem, itemMainhandAndArmor, targetArmor, targetMainhand
        time_old = time.time()
        while not msgRecved:
            sendcmd("/tell @s Test message.")
            time.sleep(0.2)
        time.sleep(0.5)
        color("§eApplying onopen plugins.")
        for i in onopen_runcode:
            try:
                exec(i)
            except Exception as err:
                errmsg = "onopenrun插件: %s 报错, 信息:\n%s" % (i.split("\n")[0][1:], str(err))
                log(errmsg)
                color("§c"+traceback.format_exc())

        color("§eStarting repeating thread.")
        thread.start_new_thread(repeating4, ())
        thread.start_new_thread(repeating, ())
        thread.start_new_thread(repeating3, ())

        tellrawText("@a", "§l§6System§r", '§6".命令"系统成功启动.')
        tellrawText("@a", "§l§6System§r", "§6共加载 §l%d§r§6 个插件/函数:" % pluginLoadedNum)
        FinishedLoadingNum = 1
        for i in pluginLoadedNameList:
            # tellrawText("@a", "§l§6System§r", "§6%d. %s" % (FinishedLoadingNum, i))
            FinishedLoadingNum += 1
        if pluginIgnoredNum >= 1:
            tellrawText("@a", "§l§4ERROR§r", "§c共忽略 §l%d§r§c 个插件/函数:" % pluginIgnoredNum)
            FinishedLoadingNum = 1
            for i in pluginIgnoredNameList:
                tellrawText("@a", "§l§4ERROR§r", "§c%d. %s" % (FinishedLoadingNum, i))
                FinishedLoadingNum += 1
        timeSpentRun = float(time.time()-timeStartRun)
        timeSpentDotCSRun = timeSpentRun-timeSpentFBRun
        color("§aDotCS Community started successfully. (total: %.2fs, DotCS: %.2fs, FB: %.2fs)" % (timeSpentRun, timeSpentDotCSRun, timeSpentFBRun))
        sendcmd("/time add 0")
        sendcmd("/gamemode c")
        sendcmd("/effect @s resistance 99999 19 true")
        sendcmd("/tp @s 10000 10000 10000")
        if getStatus("report") != "off":
            color("上报租赁服状态已开启, 可于\n§ehttp://www.dotcs.community:7913/api?type=serverRunningSearch§r\n查看, 若不想公开租赁服于网页, 请输入report off来关闭上报.")
        else:
            color("上报租赁服状态已关闭, 可输入report on重新打开.")
        # for i in range(9999):sendcmd("/say %d" % i)

        while True:
            try:
                if msgList == []:
                    if time.time()-msgLastRecvTime >= 30:
                        log("§430秒未收到包")
                        exitChatbarMenu(reason = "Receive packet timed out")
                    # else:
                    #     color(str(time.time()-msgLastRecvTime), replace = True, replaceByNext = True)
                    time.sleep(0.01)
                    continue
                else:
                    try:
                        rev = msgList.pop(0)
                        packetType = rev[0]
                        jsonPkt = json.loads(rev[1])
                    except:
                        continue
                    if packetType == 63 and jsonPkt["ActionType"] == 0:
                        XUID2playerName[jsonPkt["Entries"][0]["XUID"]] = jsonPkt["Entries"][0]["Username"]
                        jsonPkt = {'TextType': 2, 'NeedsTranslation': True, 'SourceName': '', 'Message': '§e%multiplayer.player.joining', 'Parameters': [jsonPkt["Entries"][0]["Username"]], 'XUID': '', 'PlatformChatID': '', 'PlayerRuntimeID': ''}
                        packetType = 9
                    # if "lvl" in str(jsonPkt):
                    #     print(packetType, jsonPkt)

                    # 已经实现类型数据的解析
                    # 处理文字信息.
                    if packetType == 9:
                        # 初始化
                        textType = jsonPkt["TextType"]
                        playername = jsonPkt["SourceName"]
                        msg = jsonPkt["Message"]
                        try:
                            playername = playername.replace(">§r", "").split("><")[1]
                        except:
                            pass
                        if "executing" in msg:
                            spent = time.time()-time_old
                            time_old = time.time()
                            if spent != 0:
                                tps = int(20/spent)
                                if tps <= 30:
                                    sendcmd("/scoreboard players set tps main "+str(tps))
                        elif "getting " in msg and textType != 9:
                            targString = msg.split("getting ")[1]
                            if ", " in targString:
                                target = targString.split(", ")
                            else:
                                target = []
                                target.append(targString)
                            needToGet = False
                        elif msg == "Test message.":
                            if robotname == "":
                                robotname = playername
                                log("§6Your FB robot name: %s" % robotname)
                                try:
                                    adminhigh.append(robotname)
                                except:
                                    pass
                        
                        # 处理文字信息.
                        else:
                            # 处理收到的say信息
                            # 将其统一格式
                            if textType == 8:
                                msg = msg.split("] ", 1)[1]

                            # 处理收到的tellraw信息
                            if textType == 9:
                                msg = msg.replace('{"rawtext":[{"text":"', "").replace('"}]}', "").replace('"},{"text":"', "").replace(r"\n", "\n"+"["+datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")+"] "+str(textType)+" ").replace("§l", "")
                                if msg[-1] == "\n":
                                    msg = msg[:-1]
                                if "getting" in msg and needToGetScore:
                                    try:
                                        score = int(msg.split("getting ")[1].replace("\n", ""))
                                    except:
                                        score = "获取失败"
                                    finally:
                                        needToGetScore = False
                                elif "报错, 信息:" not in msg:
                                    msg += "§r"
                                    log(str(textType)+" "+msg)
                            
                            # 处理系统信息
                            elif textType == 2:
                                # 处理玩家准备进服信息
                                if msg == "§e%multiplayer.player.joining":
                                    playername = jsonPkt["Parameters"][0]
                                    log("§e%s 正在加入游戏" % playername)

                                # 处理玩家进服信息
                                if msg == "§e%multiplayer.player.joined":
                                    playername = jsonPkt["Parameters"][0]
                                    if playername not in allplayers:
                                        allplayers.append(playername)
                                    log("§e%s 加入了游戏" % playername)
                                    thread.start_new_thread(msgPlayerJoin, (playername, msg))
                                
                                # 处理玩家退出信息
                                elif msg == "§e%multiplayer.player.left":
                                    playername = jsonPkt["Parameters"][0]
                                    if playername in allplayers:
                                        allplayers.remove(playername)
                                    log("§e%s 退出了游戏" % playername)
                                    thread.start_new_thread(msgPlayerLeave, (playername, msg))
                                    
                                # 处理玩家死亡信息
                                elif msg[0:6] == "death.":
                                    playername = jsonPkt["Parameters"][0]
                                    if len(jsonPkt["Parameters"]) == 2:
                                        killer = jsonPkt["Parameters"][1]
                                    else:
                                        killer = None
                                    log("%s 失败了, 信息: %s" % (playername, msg))
                                    thread.start_new_thread(msgPlayerDeath, (playername, msg, killer))
                                
                                # 过滤其他信息
                                else:
                                    pass
                            
                            # 处理玩家在聊天栏发送的信息, tell信息以及say信息
                            elif textType == 1 or textType == 7 or textType == 8:
                                if not msg.startswith("test"):
                                    log(str(textType)+" <"+playername+">"+" "+msg)
                                thread.start_new_thread(msgPlayerSend, (playername, msg))
                            
                            # 不记得是什么了
                            elif textType == 10:
                                pass

                    # 处理执行命令后的返回信息
                    elif packetType == 79:
                        if "getting " not in str(jsonPkt):
                            outputMessageList = jsonPkt["OutputMessages"]
                            if outputMessageList == []:
                                continue
                            # 用于getPos(), 获取坐标函数
                            if "commands.querytarget.success" in str(outputMessageList):
                                targPosList = []
                                targDimension = int(str(outputMessageList).split('    "dimension" : ')[1].split(r',\n    ')[0])
                                targPosX = float(str(outputMessageList).split(r',\n      "position" : {\n         "x" : ')[1].split(r',\n         "y" : ')[0])
                                targPosY = float(str(outputMessageList).split(r',\n         "y" : ')[1].split(r',\n         "z" : ')[0])-1.6200103759765
                                targPosZ = float(str(outputMessageList).split(r',\n         "z" : ')[1].split(r'\n      },\n      "uniqueId" : ')[0])
                                targRotY = float(str(outputMessageList).split(r',\n      "yRot" : ')[1].split(r"\n   }\n]\n']")[0])
                                targPosList.append({"dimension": targDimension, "x": str(int(targPosX)), "y": str(int(targPosY)), "z": str(int(targPosZ)), "yRot": str(int(targRotY)), "xFloat": float("%.2f" % targPosX), "yFloat": float("%.2f" % targPosY), "zFloat": float("%.2f" % targPosZ), "yRotFloat": float("%.2f" % targRotY)})
                                needToGetPos = False

                            # 用于getItem(), 获取玩家物品数量函数
                            elif "commands.clear.failure.no.items" in str(outputMessageList):
                                haveItem = 0
                                needToGetItem = False
                            elif "commands.clear.testing" in str(outputMessageList):
                                haveItem = int(outputMessageList[0]["Parameters"][1])
                                needToGetItem = False
                            elif outputMessageList[0]["Message"] == "commands.generic.syntax" and len(outputMessageList) == 1:
                                msg = outputMessageList[0]["Parameters"][0]+outputMessageList[0]["Parameters"][1]+outputMessageList[0]["Parameters"][2]
                                if msg[-5:] == " -1 0" or msg[-2:] == " 0":
                                    haveItem = 0
                                    needToGetItem = False

                    # 用于getMainhandItem(), 获取玩家手持物品名称函数
                    elif packetType == 12:
                        try:
                            entityRuntimeID2playerName[jsonPkt["EntityRuntimeID"]] = jsonPkt["Username"]
                        except:
                            pass
                        if needToGetMainhandItem and targetMainhand == jsonPkt["Username"]:
                            itemMainhand = jsonPkt["HeldItem"]["Stack"]
                            try:
                                itemMainhand["itemName"] = itemNetworkID2NameDict[str(jsonPkt["HeldItem"]["Stack"]["NetworkID"])]
                                itemMainhand["itemCmdName"] = itemNetworkID2NameEngDict[str(jsonPkt["HeldItem"]["Stack"]["NetworkID"])]
                            except:
                                itemMainhand["itemName"] = "未知"
                                itemMainhand["itemCmdName"] = "unknown"
                            needToGetMainhandItem = False
                        if needToGetMainhandAndArmorItem and targetMainhandAndArmor == jsonPkt["Username"]:
                            itemMainhandAndArmor["mainHand"] = jsonPkt["HeldItem"]["Stack"]
                            try:
                                itemMainhandAndArmor["mainHand"]["itemName"] = itemNetworkID2NameDict[str(jsonPkt["HeldItem"]["Stack"]["NetworkID"])]
                                itemMainhandAndArmor["mainHand"]["itemCmdName"] = itemNetworkID2NameEngDict[str(jsonPkt["HeldItem"]["Stack"]["NetworkID"])]
                            except:
                                itemMainhandAndArmor["mainHand"]["itemName"] = "未知"
                                itemMainhandAndArmor["mainHand"]["itemCmdName"] = "unknown"

                    # 用于getArmorItem(), 获取玩家装备物品名称函数
                    elif packetType == 32:
                        if needToGetArmorItem and targetArmor == entityRuntimeID2playerName[jsonPkt["EntityRuntimeID"]]:
                            itemArmor["Helmet"] = jsonPkt["Helmet"]["Stack"]
                            itemArmor["Chestplate"] = jsonPkt["Chestplate"]["Stack"]
                            itemArmor["Leggings"] = jsonPkt["Leggings"]["Stack"]
                            itemArmor["Boots"] = jsonPkt["Boots"]["Stack"]
                            for i in itemArmor:
                                try:
                                    itemArmor[i]["itemName"] = itemNetworkID2NameDict[str(jsonPkt[i]["Stack"]["NetworkID"])]
                                    itemArmor[i]["itemCmdName"] = itemNetworkID2NameEngDict[str(jsonPkt[i]["Stack"]["NetworkID"])]
                                except:
                                    itemArmor[i]["itemName"] = "未知"
                                    itemArmor[i]["itemCmdName"] = "unknown"
                            needToGetArmorItem = False
                        if needToGetMainhandAndArmorItem and targetMainhandAndArmor == entityRuntimeID2playerName[jsonPkt["EntityRuntimeID"]]:
                            itemMainhandAndArmor["armor"] = {}
                            itemMainhandAndArmor["armor"]["Helmet"] = jsonPkt["Helmet"]["Stack"]
                            itemMainhandAndArmor["armor"]["Chestplate"] = jsonPkt["Chestplate"]["Stack"]
                            itemMainhandAndArmor["armor"]["Leggings"] = jsonPkt["Leggings"]["Stack"]
                            itemMainhandAndArmor["armor"]["Boots"] = jsonPkt["Boots"]["Stack"]
                            for i in itemMainhandAndArmor["armor"]:
                                try:
                                    itemMainhandAndArmor["armor"][i]["itemName"] = itemNetworkID2NameDict[str(jsonPkt[i]["Stack"]["NetworkID"])]
                                    itemMainhandAndArmor["armor"][i]["itemCmdName"] = itemNetworkID2NameEngDict[str(jsonPkt[i]["Stack"]["NetworkID"])]
                                except:
                                    itemMainhandAndArmor["armor"][i]["itemName"] = "未知"
                                    itemMainhandAndArmor["armor"][i]["itemCmdName"] = "unknown"
                            needToGetMainhandAndArmorItem = False

                    # 用于getArmorItem(), 获取玩家装备物品名称函数
                    elif packetType == 203:
                        if needToGetArmorItem:
                            itemArmor = {}
                            needToGetArmorItem = False
                        if needToGetMainhandAndArmorItem:
                            itemMainhandAndArmor["armor"] = {}
                            needToGetMainhandAndArmorItem = False

                    try:
                        for i in packet_runcode:
                            if packetType == int(i.split("\n")[1].split("# packet: ")[1]):
                                exec(i)
                    except Exception as err:
                        errmsg = "packet插件: %s 报错, 信息:\n%s" % (i.split("\n")[0][1:], str(err))
                        log(errmsg, sendtogamewithERROR = True)
                        color("§c"+traceback.format_exc())

                    if False:
                        # 处理游戏时间请求更新信息
                        if revType == "SetTime":
                            # 转换游戏内时间为24小时制时间
                            timeGame = (rev.Time+6000) % 24000
                            timeGameH = timeGame // 1000
                            timeGameM = int(timeGame % 1000 * (60/1000))
                            if timeGameH <= 9:
                                timeGameHstr = "0"+str(timeGameH)
                            else:
                                timeGameHstr = str(timeGameH)
                            if timeGameM <= 9:
                                timeGameMstr = "0"+str(timeGameM)
                            else:
                                timeGameMstr = str(timeGameM)
                        # 过滤其他信息
                        else:
                            pass
            except Exception as err:
                if str(err) == "[WinError 10054] 远程主机强迫关闭了一个现有的连接。" or str(err) == "[WinError 10053] 你的主机中的软件中止了一个已建立的连接。":
                    exitChatbarMenu()
                if timesErr >= 10:
                    exitChatbarMenu()
                errmsg = "信息处理报错, 信息:\n"+str(err)
                log(errmsg)
                color("§c"+traceback.format_exc())
                timesErr += 1
            finally:
                if msgList == []:
                    time.sleep(0.01)


    # 连接FastBuilder并接收其发送来的包的函数
    def revMsg() -> None:
        """
        连接FastBuilder并接收其发送来的包的函数
        你不应该使用此函数, 命令系统会在运行FastBuilder后以新线程启动此函数
        """
        global msgLastRecvTime, timeSpentFBRun, msgRecved, msgList, timesErr, connected, connID, reconnecting, timeStartFBRun, FBlog

        # 尝试连接
        color("§eConnecting to FB program.")
        connID = conn.ConnectFB("%s:%d" % (FBip, FBport))
        if FBip == "localhost" or FBip == "127.0.0.1":
            FBlog = FBlogRead()
            while not(strInList("accept new connection", FBlog)):
                time.sleep(0.1)
                FBlog = FBlogRead()

        # 连上了
        color("§aConnected to FB program.")
        connected = True
        timeSpentFBRun = float(time.time()-timeStartFBRun)

        # 开始处理信息
        thread.start_new_thread(processMsg, ())
        # sendcmd("/gamerule sendcommandfeedback false")
        
        # 开始收取聊天信息
        while True:
            try:
                try:
                    bytesPkt = conn.RecvGamePacket(connID)
                    packetType = conn.inspectPacketID(bytesPkt)
                    msgLastRecvTime = time.time()
                    if packetType == 39 or packetType == 40 or packetType == 111 or packetType == 123 or packetType == 58:
                        continue
                    if not msgRecved:
                        if "Test message." in conn.GamePacketBytesAsIsJsonStr(bytesPkt):
                            msgRecved = True
                    msgList.append([packetType, conn.GamePacketBytesAsIsJsonStr(bytesPkt)])
                except Exception as err:
                    errmsg = "收取信息报错, 信息:\n"+str(err)
                    log(errmsg)
                    color("§c"+traceback.format_exc())
                    if ("recv on closed connection" in str(err)) or ("id 0 out of range 0" in str(err)):
                        # errmsg = "FB连接断开报错, 信息:\n"+str(err)
                        # log(errmsg)
                        # exitChatbarMenu()
                        try:
                            color("§eReconnecting to FB.")
                            reconnecting = True
                            time.sleep(1)
                            connID = conn.ConnectFB("%s:%d" % (FBip, FBport))
                            color("§aReconnected to FB program.")
                            reconnecting = False
                        except:
                            color("§4Cannot reconnect to FB program.")
                            restartFB()
                        continue
                        # exitChatbarMenu()
                    continue
            except Exception as err:
                if str(err) == "[WinError 10054] 远程主机强迫关闭了一个现有的连接。" or str(err) == "[WinError 10053] 你的主机中的软件中止了一个已建立的连接。":
                    exitChatbarMenu()
                if timesErr >= 10:
                    exitChatbarMenu()
                errmsg = "信息处理报错, 信息:\n"+str(err)
                log(errmsg)
                color("§c"+traceback.format_exc())
                timesErr += 1


    # 控制台执行代码或使用聊天栏菜单
    def consoleInput() -> None:
        """
        控制台执行代码或使用聊天栏菜单的函数
        你不应该使用此函数, 命令系统会启动时以新线程运行此函数
        """
        global outputTime
        while True:
            try:
                time.sleep(0.1)
                input_msg = input("")
                if not input_msg:
                    break
                if input_msg == "exit":
                    exitChatbarMenu()
                    break
                elif input_msg[0] == "/":
                    sendcmd(input_msg)
                elif input_msg[0] == "!":
                    sendwocmd(input_msg)
                elif input_msg[0] == "?":
                    sendfbcmd(input_msg)
                elif input_msg[0] == ".":
                    thread.start_new_thread(msgPlayerSend, (robotname, input_msg))
                elif input_msg == "list":
                    print(getTarget("@a"))
                elif input_msg == "report on":
                    setStatus("report", "on")
                    color("已开启上报租赁服运行状态")
                elif input_msg == "report off":
                    setStatus("report", "off")
                    color("已关闭上报租赁服运行状态")
                elif input_msg == "output time long":
                    outputTime = "long"
                    color("已设定输出显示长时间")
                elif input_msg == "output time short":
                    outputTime = "short"
                    color("已设定输出显示短时间")
                elif input_msg == "output time none":
                    outputTime = "none"
                    color("已关闭输出显示时间")
                elif input_msg == "set server number":
                    with open("server.txt", "r") as file:
                        FBconfig = eval(file.read().replace("false","False").replace("true","True"))
                        FBconfig["serverNumber"] = input("服号: ")
                    with open("server.txt", "w") as file:
                        file.write(str(FBconfig).replace("False","false").replace("True","true").replace("'", '"'))
                    color("§a成功设置服号")
                    exitChatbarMenu()
                else:
                    exec(input_msg)
            except Exception as err:
                errmsg = "console()报错, 信息:\n"+str(err)
                log(errmsg, sendtogamewithERROR = True)
                color("§c"+traceback.format_exc())




    # 开始运行robot.py
    if __name__ == "__main__":
        version = "v0.8.4" # 设置版本号
        timeStartRun = time.time() # 记录启动时间
        connected = False
        reconnecting = False
        needToGetMainhandItem = False
        needToGetArmorItem = False
        needToGetMainhandAndArmorItem = False
        targetMainhandAndArmor = ""
        # FBip = "43.154.99.183"
        FBip = "127.0.0.1"
        FBport = 8000
        # FBip = "124.222.6.29"
        # FBport = 3456
        os.system("del robot_old.exe")
        countdown(3, "§e命令系统即将开始启动")


        # 输出说明
        color(title4)
        color('§b".命令"系统 - 租赁服聊天栏菜单\n".Dot" Command System (DotCS)\n作者: art, 7912\n本程序基于FastBuilder及2401编写的连接FB与命令系统的代码')
        color('§b用户交流群: 467443403')
        countdown(3, "§e请阅读说明")

        # 检测fbtoken文件
        if "fbtoken" not in os.listdir():
            color("§4请下载fbtoken, 放进目录后重启.")
            raise Exception("fbtoken not found")

        # 输出说明
        color("FB connection address: %s:%d" % (FBip, FBport))

        # 如果租赁服号未设置, 则请求输入租赁服号并存入server.txt
        print("Reading server number: ", end = "")
        with open("server.txt") as file:
            FBconfig = eval(file.read().replace("false","False").replace("true","True"))
            server = FBconfig["serverNumber"]
            serverPassword = FBconfig["serverPassword"]
            print(server)
            if server == "12345678":
                FBconfig["serverNumber"] = input("检测到租赁服号未设置, 请输入: ")
                if FBconfig["serverNumber"] == "":
                    raise Exception("Netease server number error")
                server = FBconfig["serverNumber"]
                print("成功设置服号, 若设置错误可修改server.txt文件.")
            if serverPassword == "123456":
                FBconfig["serverPassword"] = input("请输入租赁服密码, 若没有, 输入任意不等于123456的六位数: ")
                if len(FBconfig["serverPassword"]) != 6 or FBconfig["serverPassword"] == "123456":
                    raise Exception("Netease server password error")
                serverPassword = FBconfig["serverPassword"]
                print("成功设置密码, 若设置错误可修改server.txt文件.")
        with open("server.txt", "w") as file:
            file.write(str(FBconfig).replace("False","false").replace("True","true").replace("'", '"'))

        FBkill()

        # 检测命令系统是否有更新和你的租赁服号是否被命令系统封禁
        updateCheck()
        blackListCheck()

        # 进行非本体更新
        if "basic_频率执行_onopenrun.py" in os.listdir("plugin"):
            os.system("del plugin\\basic_频率执行_onopenrun.py")
        if "basic_控制台执行指令_onopenrun.py" in os.listdir("plugin"):
            os.system("del plugin\\basic_控制台执行指令_onopenrun.py")
        if "记录租赁服运行时间_repeat10s.py" in os.listdir("plugin"):
            os.system("del plugin\\记录租赁服运行时间_repeat10s.py")
        if getStatus("update1") != "完成":
            os.system("curl --output plugin\\basic_主菜单_cmdsrun.py http://www.dotcs.community/update/basic_主菜单_cmdsrun.py")
            os.system("curl --output plugin\\htp玩家互传_cmdsrun.py http://www.dotcs.community/update/htp玩家互传_cmdsrun.py")
            os.system("curl --output plugin\\封禁系统_cmdsrun.py http://www.dotcs.community/update/封禁系统_cmdsrun.py")
            os.system("curl --output plugin\\获取玩家手持物品_def.py http://www.dotcs.community/update/获取玩家手持物品_def.py")
            os.system("curl --output plugin\\金币银行_cmdsrun.py http://www.dotcs.community/update/金币银行_cmdsrun.py")
            os.system("curl --output plugin\\群服互通_cmdsrun.py http://www.dotcs.community/update/群服互通_cmdsrun.py")
            if "获取玩家手持物品_def.py" not in os.listdir("plugin"):
                os.system("curl --output plugin\\获取玩家手持物品_def.py http://www.dotcs.community/update/获取玩家手持物品_def.py")
                os.system("curl --output status\\itemNetworkID.txt http://www.dotcs.community/update/itemNetworkID.txt")
            setStatus("update1", "完成")
        if getStatus("update2") != "完成":
            os.system("curl --output plugin\\金币银行_cmdsrun.py http://www.dotcs.community/update/金币银行_cmdsrun.py")
            setStatus("update2", "完成")
        if getStatus("update3") != "完成":
            os.system("curl --output plugin\\封禁系统_repeat10s.py http://www.dotcs.community/update/封禁系统_repeat10s.py")
            os.system("curl --output plugin\\封禁系统_join.py http://www.dotcs.community/update/封禁系统_join.py")
            os.system("curl --output plugin\\封禁系统_def.py http://www.dotcs.community/update/封禁系统_def.py")
            os.system("curl --output plugin\\封禁系统_cmdsrun.py http://www.dotcs.community/update/封禁系统_cmdsrun.py")
            os.system("curl --output plugin\\封禁系统_onopenrun.py http://www.dotcs.community/update/封禁系统_onopenrun.py")
            setStatus("update3", "完成")


        # 加载插件
        color("§eLoading plugins.")
        # time.sleep(0.2)
        pluginlist = os.listdir("plugin")
        cmds_runcode = []
        onopen_runcode = []
        repeat1s_runcode = []
        repeat10s_runcode = []
        join_runcode = []
        left_runcode = []
        death_runcode = []
        packet_runcode = []
        pluginLoadedNum = 0
        pluginLoadedNameList = []
        pluginIgnoredNum = 0
        pluginIgnoredNameList = []
        for filename in pluginlist:
            try:
                if filename[-10:-3]=="cmdsrun":
                    color("§eNow loading: %s" % filename, replace = True)
                    if platformVer == "Windows":
                        plugincode = open("plugin\\"+filename, "r", encoding = "utf-8")
                    else:
                        plugincode = open("plugin/"+filename, "r", encoding = "utf-8")
                    if filename[0:4] == "enc_":
                        cmds_runcode.append(pluginDec(plugincode.read()))
                    else:
                        cmds_runcode.append("#%s\n%s" % (filename, plugincode.read()))
                    plugincode.close()
                    try:
                        if filename.replace("_cmdsrun.py", "") not in pluginLoadedNameList:
                            pluginLoadedNum += 1
                            pluginLoadedNameList.append(filename.replace("_cmdsrun.py", ""))
                    except Exception as err:
                        color("§4Ignored: %s, reason: %s\n" % (filename, err), replace = True)
                        pluginIgnoredNum += 1
                        pluginIgnoredNameList.append(filename+", 原因: "+str(err))
                elif filename[-11:-3]=="repeat1s":
                    color("§eNow loading: %s" % filename, replace = True)
                    if platformVer == "Windows":
                        plugincode = open("plugin\\"+filename, "r", encoding = "utf-8")
                    else:
                        plugincode = open("plugin/"+filename, "r", encoding = "utf-8")
                    if filename[0:4] == "enc_":
                        repeat1s_runcode.append(pluginDec(plugincode.read()).replace("game.ws.close()", "exitChatbarMenu()"))
                    else:
                        repeat1s_runcode.append("#%s\n%s" % (filename, plugincode.read().replace("game.ws.close()", "exitChatbarMenu()")))
                    plugincode.close()
                    try:
                        if filename.replace("_repeat1s.py", "") not in pluginLoadedNameList:
                            pluginLoadedNum += 1
                            pluginLoadedNameList.append(filename.replace("_repeat1s.py", ""))
                    except Exception as err:
                        color("§4Ignored: %s, reason: %s\n" % (filename, err), replace = True)
                        pluginIgnoredNum += 1
                        pluginIgnoredNameList.append(filename+", 原因: "+str(err))
                elif filename[-12:-3]=="repeat10s":
                    color("§eNow loading: %s" % filename, replace = True)
                    if platformVer == "Windows":
                        plugincode = open("plugin\\"+filename, "r", encoding = "utf-8")
                    else:
                        plugincode = open("plugin/"+filename, "r", encoding = "utf-8")
                    if filename[0:4] == "enc_":
                        repeat10s_runcode.append(pluginDec(plugincode.read()))
                    else:
                        repeat10s_runcode.append("#%s\n%s" % (filename, plugincode.read()))
                    plugincode.close()
                    try:
                        if filename.replace("_repeat10s.py", "") not in pluginLoadedNameList:
                            pluginLoadedNum += 1
                            pluginLoadedNameList.append(filename.replace("_repeat10s.py", ""))
                    except Exception as err:
                        color("§4Ignored: %s, reason: %s\n" % (filename, err), replace = True)
                        pluginIgnoredNum += 1
                        pluginIgnoredNameList.append(filename+", 原因: "+str(err))
                elif filename[-12:-3]=="onopenrun":
                    color("§eNow loading: %s" % filename, replace = True)
                    if platformVer == "Windows":
                        plugincode = open("plugin\\"+filename, "r", encoding = "utf-8")
                    else:
                        plugincode = open("plugin/"+filename, "r", encoding = "utf-8")
                    if filename[0:4] == "enc_":
                        onopen_runcode.append(pluginDec(plugincode.read()))
                    else:
                        onopen_runcode.append("#%s\n%s" % (filename, plugincode.read()))
                    plugincode.close()
                    try:
                        if filename.replace("_onopenrun.py", "") not in pluginLoadedNameList:
                            pluginLoadedNum += 1
                            pluginLoadedNameList.append(filename.replace("_onopenrun.py", ""))
                    except Exception as err:
                        color("§4Ignored: %s, reason: %s\n" % (filename, err), replace = True)
                        pluginIgnoredNum += 1
                        pluginIgnoredNameList.append(filename+", 原因: "+str(err))
                elif filename[-6:-3]=="def":
                    color("§eNow loading: %s" % filename, replace = True)
                    if platformVer == "Windows":
                        plugincode = open("plugin\\"+filename, "r", encoding = "utf-8")
                    else:
                        plugincode = open("plugin/"+filename, "r", encoding = "utf-8")
                    code = plugincode.read()
                    if filename[0:4] == "enc_":
                        code = pluginDec(code)
                    plugincode.close()
                    try:
                        exec(code)
                        if filename.replace("_def.py", "") not in pluginLoadedNameList:
                            pluginLoadedNum += 1
                            pluginLoadedNameList.append(filename.replace("_def.py", ""))
                    except Exception as err:
                        color("§4Ignored: %s, reason: %s\n%s\n" % (filename, err, "§c"+traceback.format_exc()), replace = True)
                        pluginIgnoredNum += 1
                        pluginIgnoredNameList.append(filename+", 原因: "+str(err))
                elif filename[-7:-3]=="join":
                    color("§eNow loading: %s" % filename, replace = True)
                    if platformVer == "Windows":
                        plugincode = open("plugin\\"+filename, "r", encoding = "utf-8")
                    else:
                        plugincode = open("plugin/"+filename, "r", encoding = "utf-8")
                    if filename[0:4] == "enc_":
                        join_runcode.append(pluginDec(plugincode.read()))
                    else:
                        join_runcode.append("#%s\n%s" % (filename, plugincode.read()))
                    plugincode.close()
                    try:
                        if filename.replace("_join.py", "") not in pluginLoadedNameList:
                            pluginLoadedNum += 1
                            pluginLoadedNameList.append(filename.replace("_join.py", ""))
                    except Exception as err:
                        color("§4Ignored: %s, reason: %s\n" % (filename, err), replace = True)
                        pluginIgnoredNum += 1
                        pluginIgnoredNameList.append(filename+", 原因: "+str(err))
                elif filename[-7:-3]=="left":
                    color("§eNow loading: %s" % filename, replace = True)
                    if platformVer == "Windows":
                        plugincode = open("plugin\\"+filename, "r", encoding = "utf-8")
                    else:
                        plugincode = open("plugin/"+filename, "r", encoding = "utf-8")
                    if filename[0:4] == "enc_":
                        left_runcode.append(pluginDec(plugincode.read()))
                    else:
                        left_runcode.append("#%s\n%s" % (filename, plugincode.read()))
                    plugincode.close()
                    try:
                        if filename.replace("_left.py", "") not in pluginLoadedNameList:
                            pluginLoadedNum += 1
                            pluginLoadedNameList.append(filename.replace("_left.py", ""))
                    except Exception as err:
                        color("§4Ignored: %s, reason: %s\n" % (filename, err), replace = True)
                        pluginIgnoredNum += 1
                        pluginIgnoredNameList.append(filename+", 原因: "+str(err))
                elif filename[-8:-3]=="death":
                    color("§eNow loading: %s" % filename, replace = True)
                    if platformVer == "Windows":
                        plugincode = open("plugin\\"+filename, "r", encoding = "utf-8")
                    else:
                        plugincode = open("plugin/"+filename, "r", encoding = "utf-8")
                    if filename[0:4] == "enc_":
                        death_runcode.append(pluginDec(plugincode.read()))
                    else:
                        death_runcode.append("#%s\n%s" % (filename, plugincode.read()))
                    plugincode.close()
                    try:
                        if filename.replace("_death.py", "") not in pluginLoadedNameList:
                            pluginLoadedNum += 1
                            pluginLoadedNameList.append(filename.replace("_death.py", ""))
                    except Exception as err:
                        color("§4Ignored: %s, reason: %s\n" % (filename, err), replace = True)
                        pluginIgnoredNum += 1
                        pluginIgnoredNameList.append(filename+", 原因: "+str(err))
                elif filename[-9:-3]=="packet":
                    color("§eNow loading: %s" % filename, replace = True)
                    if platformVer == "Windows":
                        plugincode = open("plugin\\"+filename, "r", encoding = "utf-8").read()
                    else:
                        plugincode = open("plugin/"+filename, "r", encoding = "utf-8").read()
                    try:
                        int(plugincode.split("\n")[0].split("# packet: ")[1])
                    except:
                        raise Exception("packet setting error")
                    if filename[0:4] == "enc_":
                        packet_runcode.append(pluginDec(plugincode))
                    else:
                        packet_runcode.append("#%s\n%s" % (filename, plugincode))
                    try:
                        if filename.replace("_packet.py", "") not in pluginLoadedNameList:
                            pluginLoadedNum += 1
                            pluginLoadedNameList.append(filename.replace("_packet.py", ""))
                    except Exception as err:
                        color("§4Ignored: %s, reason: %s\n" % (filename, err), replace = True)
                        pluginIgnoredNum += 1
                        pluginIgnoredNameList.append(filename+", 原因: "+str(err))
                else:
                    color("§4Ignored: %s, reason: Wrong filename type.\n" % filename, replace = True)
                    pluginIgnoredNum += 1
                    pluginIgnoredNameList.append(filename+", 原因: 命名不规范.")
            except Exception as err:
                color("§4Ignored: %s, reason: %s\n%s\n" % (filename, err, "§c"+traceback.format_exc()), replace = True)
                pluginIgnoredNum += 1
                pluginIgnoredNameList.append(filename+", 原因: "+str(err))
            finally:
                pass
                # time.sleep(0.05)
        color("§aLoaded all plugins.", replace = True)
        # time.sleep(0.2)

        # 启动FB
        runFB()
        # thread.start_new_thread(runFB, ())
        timeStartFBRun = time.time()

        # 开始尝试连接
        color("§eWaiting for FB to connect to server %s, please wait." % server)
        try:
            if FBip == "localhost" or FBip == "127.0.0.1":
                FBlog = FBlogRead()
                while not(strInList("0.0.0.0:%d" % FBport, FBlog)):
                    timeSpentFBStart = time.time()-timeStartFBRun
                    color("§eConnecting..., %.2fs/20s" % timeSpentFBStart, replace = True, replaceByNext = True)
                    if timeSpentFBStart >= 20:
                        color("§4FB超过20秒未连接上租赁服, 正在退出.")
                        exitChatbarMenu(reason = "FB timed out.")
                    time.sleep(0.1)
                    FBlog = FBlogRead()
            thread.start_new_thread(consoleInput, ())
            revMsg()
        except Exception as err:
            color("§4连接失败, 信息:\n"+str(err))
            color("§c"+traceback.format_exc())
        finally:
            pass


        # FB从租赁服断开连接, 退出
        exitChatbarMenu()

except Exception as err:
    color("§4命令系统运行出错, 信息:\n"+str(err))
    color("§c"+traceback.format_exc())
    exitChatbarMenu()
except KeyboardInterrupt:
    exitChatbarMenu(reason = "KeyboardInterrupt")
except SystemExit:
    exitChatbarMenu(reason = "SystemExit")
except:
    color("§4命令系统运行出错, 无法获取错误信息.")
    color("§c"+traceback.format_exc())
    exitChatbarMenu()
